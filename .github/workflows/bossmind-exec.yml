name: BossMind Execution

on:
  workflow_dispatch:
    inputs:
      action:
        description: "Choose what to run"
        required: true
        default: "trigger_deploy"
        type: choice
        options:
          - trigger_deploy
          - health_check
      url_to_check:
        description: "URL to check (used only for health_check)"
        required: false
        default: "https://video.bossmind.ai/"
        type: string

# IMPORTANT: allow workflow to push commits (needed for trigger_deploy)
permissions:
  contents: write

jobs:
  bossmind:
    name: bossmind
    runs-on: ubuntu-latest

    steps:
      - name: Set up job
        run: echo "BossMind job starting..."

      # Checkout using your fine-grained PAT (so future git operations can authenticate)
      - name: Checkout (with BossMind token)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.BOSSMIND_GITHUB_TOKEN }}

      - name: Configure Git identity
        run: |
          git config --global user.email "bossmind@ai.local"
          git config --global user.name "BossMind"

      - name: Decide action
        id: decide
        run: |
          echo "ACTION=${{ inputs.action }}" >> $GITHUB_ENV
          echo "URL_TO_CHECK=${{ inputs.url_to_check }}" >> $GITHUB_ENV

      # âœ… FIXED: git push will use BOSSMIND_GITHUB_TOKEN explicitly
      - name: Trigger Railway deploy (safe empty commit)
        if: env.ACTION == 'trigger_deploy'
        env:
          BOSSMIND_GITHUB_TOKEN: ${{ secrets.BOSSMIND_GITHUB_TOKEN }}
        run: |
          TS="$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          echo "[main $(git rev-parse --short HEAD)] BossMind: trigger deploy @ $TS"

          # Force HTTPS remote to authenticate using the PAT
          git remote set-url origin "https://x-access-token:${BOSSMIND_GITHUB_TOKEN}@github.com/${{ github.repository }}.git"

          # Empty commit to trigger Railway/Git-based deploy hooks
          git commit --allow-empty -m "BossMind: trigger deploy @ ${TS}" || true

          # Push to the same branch this workflow ran on (usually main)
          git push origin "${{ github.ref_name }}"

      - name: Health check (HTTP status)
        if: env.ACTION == 'health_check'
        run: |
          echo "Checking: ${URL_TO_CHECK}"
          code=$(curl -s -o /dev/null -w "%{http_code}" "${URL_TO_CHECK}" || true)
          echo "HTTP_STATUS=${code}"
          if [ "${code}" = "200" ] || [ "${code}" = "301" ] || [ "${code}" = "302" ]; then
            echo "Health check OK"
            exit 0
          fi
          echo "Health check FAILED"
          exit 1

      - name: Post Checkout (with BossMind token)
        run: echo "Post-checkout complete."

      - name: Complete job
        run: echo "BossMind job complete."
