<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BossMind Admin — Automation Center</title>

  <style>
    :root{
      --bg:#0b0f16;
      --panel:#0f1623;
      --panel2:#0c1220;
      --card:#111b2b;
      --line:rgba(255,255,255,.08);
      --text:#e7eaf1;
      --muted:#a7b0c0;
      --ok:#1ee3a5;
      --warn:#f5c542;
      --bad:#ff4d6d;
      --brand1:#7c3aed;
      --brand2:#22c55e;
      --brand3:#f59e0b;
      --chip:#121b2a;
      --shadow: 0 18px 50px rgba(0,0,0,.45);
      --radius: 16px;
      --radius2: 22px;
    }

    /* ✅ IMPORTANT: No zoom, no transform scale — prevents "tiny centered" layout */
    * { box-sizing: border-box; }
    html,body { height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:
        radial-gradient(1100px 600px at 12% 18%, rgba(124,58,237,.35), transparent 60%),
        radial-gradient(900px 500px at 88% 20%, rgba(34,197,94,.18), transparent 55%),
        radial-gradient(900px 700px at 85% 85%, rgba(245,158,11,.16), transparent 60%),
        linear-gradient(180deg, #070a10, var(--bg));
      overflow-x:hidden;
    }

    .wrap{
      width: min(1320px, calc(100% - 32px));
      margin: 24px auto 40px;
    }

    .topbar{
      display:flex;
      gap:16px;
      align-items:flex-start;
      justify-content:space-between;
      padding: 16px 16px 8px;
      border:1px solid var(--line);
      background: rgba(15,22,35,.70);
      backdrop-filter: blur(10px);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
    }

    .brand{
      display:flex;
      gap:12px;
      align-items:center;
      min-width: 280px;
    }
    .logo{
      width:44px;height:44px;border-radius:14px;
      background: linear-gradient(135deg, rgba(124,58,237,1), rgba(34,197,94,1));
      box-shadow: 0 10px 30px rgba(124,58,237,.25);
    }
    .title{
      display:flex;flex-direction:column;gap:2px;
    }
    .title h1{
      margin:0;
      font-size: 16px;
      font-weight: 750;
      letter-spacing: .2px;
    }
    .title p{
      margin:0;
      font-size: 12px;
      color: var(--muted);
      opacity:.95;
    }

    .actions{
      display:flex;
      gap:10px;
      flex-wrap: wrap;
      justify-content:flex-end;
      padding-top: 2px;
    }

    .btn{
      display:inline-flex;
      gap:8px;
      align-items:center;
      justify-content:center;
      border: 1px solid var(--line);
      background: rgba(17,27,43,.72);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 999px;
      font-weight: 650;
      font-size: 12px;
      cursor:pointer;
      user-select:none;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      white-space:nowrap;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(20,33,54,.78); border-color: rgba(255,255,255,.14); }
    .btn:active{ transform: translateY(0px); }
    .btn.purple{ background: rgba(124,58,237,.18); border-color: rgba(124,58,237,.35); }
    .btn.green{ background: rgba(34,197,94,.14); border-color: rgba(34,197,94,.30); }
    .btn.gold{ background: rgba(245,158,11,.14); border-color: rgba(245,158,11,.30); }
    .btn.ghost{ background: rgba(17,27,43,.40); }

    .row{
      display:grid;
      grid-template-columns: 1.25fr .95fr;
      gap: 16px;
      margin-top: 14px;
    }
    @media (max-width: 1100px){
      .row{ grid-template-columns: 1fr; }
      .actions{ justify-content:flex-start; }
    }

    .tabs{
      display:flex;
      gap:10px;
      padding: 10px 12px 14px;
      flex-wrap:wrap;
      align-items:center;
    }
    .tab{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding: 9px 12px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(17,27,43,.55);
      color: var(--text);
      cursor:pointer;
      font-weight: 700;
      font-size: 12px;
      transition: background .12s ease, border-color .12s ease;
    }
    .tab:hover{ background: rgba(20,33,54,.70); border-color: rgba(255,255,255,.14); }
    .tab.active{
      background: rgba(124,58,237,.22);
      border-color: rgba(124,58,237,.40);
      box-shadow: 0 10px 28px rgba(124,58,237,.12);
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(17,27,43,.55);
      font-size: 12px;
      color: var(--muted);
      margin-left:auto;
      white-space:nowrap;
    }
    .dot{
      width:9px;height:9px;border-radius:99px;
      background: var(--bad);
      box-shadow: 0 0 0 3px rgba(255,77,109,.12);
    }

    .card{
      border:1px solid var(--line);
      background: rgba(15,22,35,.65);
      backdrop-filter: blur(10px);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHeader{
      padding: 14px 14px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      background: rgba(12,18,32,.25);
    }
    .cardHeader h2{
      margin:0;
      font-size: 13px;
      font-weight: 800;
      letter-spacing: .2px;
    }
    .sub{
      margin:0;
      color: var(--muted);
      font-size: 12px;
      font-weight: 600;
    }

    .section{
      padding: 14px;
      display:flex;
      flex-direction:column;
      gap: 12px;
    }
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 680px){
      .grid2{ grid-template-columns: 1fr; }
      .pill{ margin-left:0; width: fit-content; }
    }

    .box{
      border:1px solid rgba(255,255,255,.08);
      background: rgba(12,18,32,.42);
      border-radius: var(--radius);
      padding: 12px;
    }

    label{
      font-size: 12px;
      font-weight: 750;
      color: var(--muted);
      display:block;
      margin-bottom: 6px;
    }
    .input{
      width:100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(8,12,18,.65);
      color: var(--text);
      outline:none;
      font-weight: 650;
      font-size: 12px;
    }
    .hint{
      margin-top: 8px;
      font-size: 11px;
      color: rgba(167,176,192,.85);
      line-height: 1.35;
    }

    .btnRow{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    .taskRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }

    .table{
      width:100%;
      border-collapse: collapse;
      overflow:hidden;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(8,12,18,.45);
    }
    .table th, .table td{
      padding: 10px 10px;
      text-align:left;
      font-size: 12px;
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .table th{
      color: var(--muted);
      font-weight: 800;
      background: rgba(12,18,32,.35);
    }
    .table td{
      color: rgba(231,234,241,.92);
      font-weight: 650;
    }
    .table tr:last-child td{ border-bottom:none; }

    .rightTop{
      display:flex;
      align-items:center;
      gap:10px;
    }

    .select{
      width:100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(8,12,18,.65);
      color: var(--text);
      outline:none;
      font-weight: 750;
      font-size: 12px;
    }

    .logBox{
      height: 220px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(8,12,18,.52);
      padding: 10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 11px;
      overflow:auto;
      color: rgba(231,234,241,.88);
      line-height: 1.35;
      white-space: pre-wrap;
    }

    .muted{ color: var(--muted); }
    .kpi{
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(18,27,42,.55);
      font-size: 12px;
      font-weight: 750;
      color: rgba(231,234,241,.92);
      white-space:nowrap;
    }
    .chip .dot{ width:8px;height:8px; box-shadow:none; }
    .chip.ok .dot{ background: var(--ok); }
    .chip.warn .dot{ background: var(--warn); }
    .chip.bad .dot{ background: var(--bad); }

    .footerNote{
      margin-top: 12px;
      font-size: 11px;
      color: rgba(167,176,192,.8);
    }

    /* Panels */
    .panel{ display:none; }
    .panel.active{ display:block; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="title">
          <h1>BossMind Admin — Automation Center</h1>
          <p>3 Projects • Queue • Switches • Jobs • Logs • Health</p>
        </div>
      </div>

      <div class="actions">
        <button class="btn purple" id="btnRefreshAll">↻ Refresh All</button>
        <button class="btn green" id="btnHealth">✓ Run Health Check</button>
        <button class="btn gold" id="btnSyncAll">⇄ Sync (Sheet / DB / Config)</button>
      </div>
    </div>

    <!-- ✅ TABS: Project 3 aligned exactly like 1 & 2 -->
    <div class="tabs">
      <button class="tab active" data-tab="p1" id="tabP1">Project 1 — AI Builder</button>
      <button class="tab" data-tab="p2" id="tabP2">Project 2 — AI Video Generator</button>
      <button class="tab" data-tab="p3" id="tabP3">Project 3 — AI Stock System</button>

      <div class="pill" title="UI status only. Backend status depends on API Base URL.">
        <span class="dot" id="backendDot"></span>
        <span id="backendText">Backend: down</span>
        <span style="opacity:.55">•</span>
        <span id="clockText"></span>
      </div>
    </div>

    <div class="row">
      <!-- LEFT: Project panel -->
      <div class="card">
        <div class="cardHeader">
          <div>
            <h2 id="panelTitle">Project 1 — AI Builder</h2>
            <p class="sub" id="panelSub">Core tasks, status snapshot, and connection</p>
          </div>
        </div>

        <div class="section">
          <div class="box">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
              <div>
                <div style="font-weight:850; font-size:12px; margin-bottom:4px;">Connection</div>
                <div class="muted" style="font-size:11px;">Set the API base URL used for all actions in this dashboard.</div>
              </div>
              <div class="kpi">
                <span class="chip bad"><span class="dot"></span><span id="chipApi">API: not set</span></span>
              </div>
            </div>

            <div class="grid2" style="margin-top:12px;">
              <div>
                <label for="apiBase">API Base URL (Railway / Production)</label>
                <input class="input" id="apiBase" placeholder="https://your-service.up.railway.app" />
                <div class="hint">This page calls your backend endpoints using this base URL.</div>
              </div>
              <div>
                <label for="adminKey">Admin Key (optional)</label>
                <input class="input" id="adminKey" placeholder="(if your backend requires x-admin-key)" />
                <div class="hint">If enabled on backend, it will be sent as header <b>x-admin-key</b>.</div>
              </div>
            </div>

            <div class="btnRow">
              <button class="btn purple" id="btnSaveConn">Save</button>
              <button class="btn ghost" id="btnPing">Ping</button>
            </div>
          </div>

          <!-- PANELS -->
          <div class="panel active" id="panelP1">
            <div class="box">
              <div style="font-weight:850; font-size:12px; margin-bottom:10px;">Core Tasks</div>
              <div class="taskRow">
                <button class="btn green" data-job="builder.generatePreview">Generate Preview</button>
                <button class="btn purple" data-job="builder.exportLayout">Export Layout</button>
                <button class="btn gold" data-job="builder.syncSupabase">Sync Supabase</button>
                <button class="btn ghost" data-job="builder.rotateTheme">Rotate Theme</button>
              </div>
              <div class="footerNote">Recommended backend endpoint: <b>POST /api/admin/jobs</b> with <b>{ job, scope }</b>.</div>
            </div>

            <div class="box">
              <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
                <div style="font-weight:850; font-size:12px;">Status Snapshot</div>
                <button class="btn ghost" id="btnRefreshStatus">Refresh Builder Status</button>
              </div>
              <div style="margin-top:10px;">
                <table class="table">
                  <thead>
                    <tr><th style="width:55%">Item</th><th>Value</th></tr>
                  </thead>
                  <tbody>
                    <tr><td>Last Export</td><td id="s1">—</td></tr>
                    <tr><td>Supabase Sync</td><td id="s2">—</td></tr>
                    <tr><td>Active Theme</td><td id="s3">—</td></tr>
                    <tr><td>Errors (24h)</td><td id="s4">—</td></tr>
                  </tbody>
                </table>
              </div>
              <div class="footerNote">Endpoint expected: <b>GET /api/admin/status/builder</b></div>
            </div>
          </div>

          <div class="panel" id="panelP2">
            <div class="box">
              <div style="font-weight:850; font-size:12px; margin-bottom:10px;">Video Generator Tasks</div>
              <div class="taskRow">
                <button class="btn green" data-job="video.queueFromSheet">Queue from Google Sheet</button>
                <button class="btn purple" data-job="video.reviewScenario">Scenario Review</button>
                <button class="btn gold" data-job="video.renderNext">Render Next</button>
                <button class="btn ghost" data-job="video.publish">Publish (YouTube/TikTok)</button>
              </div>
              <div class="footerNote">Recommended backend endpoint: <b>POST /api/admin/jobs</b> with <b>{ job, scope }</b>.</div>
            </div>

            <div class="box">
              <div style="font-weight:850; font-size:12px; margin-bottom:10px;">Video Type Selector</div>
              <div class="grid2">
                <div>
                  <label for="videoType">Select Video Type</label>
                  <select class="select" id="videoType">
                    <option value="funny">Funny</option>
                    <option value="drama">Drama</option>
                    <option value="thriller">Thriller</option>
                    <option value="adventure">Adventure</option>
                    <option value="educational">Educational</option>
                    <option value="motivation">Motivation</option>
                  </select>
                  <div class="hint">Saved locally. Backend can read it via job payload.</div>
                </div>
                <div>
                  <label for="videoLang">Default Language</label>
                  <select class="select" id="videoLang">
                    <option value="auto">Auto (viewer IP)</option>
                    <option value="ar">Arabic</option>
                    <option value="en">English</option>
                    <option value="fr">French</option>
                    <option value="de">German</option>
                    <option value="es">Spanish</option>
                    <option value="ru">Russian</option>
                    <option value="sq">Albanian</option>
                  </select>
                  <div class="hint">Saved locally. Used in job payload if you trigger tasks here.</div>
                </div>
              </div>

              <div class="btnRow">
                <button class="btn purple" id="btnSaveVideoPrefs">Save Video Preferences</button>
              </div>

              <div class="footerNote">Recommended: <b>POST /api/admin/video/prefs</b> or include prefs in <b>POST /api/admin/jobs</b>.</div>
            </div>
          </div>

          <div class="panel" id="panelP3">
            <div class="box">
              <div style="font-weight:850; font-size:12px; margin-bottom:10px;">Stock System Tasks (Stock only)</div>
              <div class="taskRow">
                <button class="btn green" data-job="stock.syncWatchlist">Sync Watchlist</button>
                <button class="btn purple" data-job="stock.runSignals">Run AI Signals</button>
                <button class="btn gold" data-job="stock.riskScan">Run Risk Scan</button>
                <button class="btn ghost" data-job="stock.exportReport">Export Report</button>
              </div>
              <div class="footerNote">Recommended backend endpoint: <b>POST /api/admin/jobs</b> with <b>{ job, scope }</b>.</div>
            </div>

            <div class="box">
              <div style="font-weight:850; font-size:12px; margin-bottom:10px;">Stock Snapshot</div>
              <table class="table">
                <thead><tr><th style="width:55%">Item</th><th>Value</th></tr></thead>
                <tbody>
                  <tr><td>Market Session</td><td id="stk1">—</td></tr>
                  <tr><td>Signals (today)</td><td id="stk2">—</td></tr>
                  <tr><td>Risk Level</td><td id="stk3">—</td></tr>
                  <tr><td>Last Report</td><td id="stk4">—</td></tr>
                </tbody>
              </table>
              <div class="footerNote">Endpoint expected: <b>GET /api/admin/status/stock</b></div>
            </div>
          </div>

        </div>
      </div>

      <!-- RIGHT: Controls + Logs -->
      <div class="card">
        <div class="cardHeader">
          <div>
            <h2>Control + Logs</h2>
            <p class="sub">Maintenance, switches, job logs, and local controls</p>
          </div>

          <div class="rightTop">
            <button class="btn ghost" id="btnLoadLogs">Load Logs</button>
            <button class="btn ghost" id="btnAutoToggle">Auto: OFF</button>
          </div>
        </div>

        <div class="section">
          <div class="box">
            <div style="font-weight:850; font-size:12px; margin-bottom:10px;">Maintenance + Switch Control (UI Ready)</div>

            <div class="grid2">
              <div>
                <label for="maintenanceMode">Maintenance Mode</label>
                <select class="select" id="maintenanceMode">
                  <option value="off">OFF</option>
                  <option value="on">ON</option>
                </select>
              </div>
              <div>
                <label for="featureSet">Feature Switch Set</label>
                <select class="select" id="featureSet">
                  <option value="builder">AI Builder</option>
                  <option value="video">AI Video Generator</option>
                  <option value="stock">AI Stock System</option>
                </select>
              </div>
            </div>

            <div class="grid2" style="margin-top:10px;">
              <div class="box" style="padding:10px;">
                <div class="muted" style="font-weight:800; font-size:12px; margin-bottom:8px;">Core Switches</div>
                <div class="taskRow">
                  <button class="btn ghost" data-switch="deepseek">DeepSeek</button>
                  <button class="btn ghost" data-switch="stripeLogs">Stripe Logs</button>
                  <button class="btn ghost" data-switch="webhookTriggers">Webhook Triggers</button>
                </div>
              </div>

              <div class="box" style="padding:10px;">
                <div class="muted" style="font-weight:800; font-size:12px; margin-bottom:8px;">Safety / Ops</div>
                <div class="taskRow">
                  <button class="btn ghost" data-switch="autoDisableOnErrors">Auto-Disable on Errors</button>
                  <button class="btn ghost" data-switch="backups">Backups</button>
                  <button class="btn ghost" data-switch="notifications">Notifications</button>
                </div>
              </div>
            </div>

            <div class="btnRow" style="margin-top:10px;">
              <button class="btn gold" id="btnApplyMaintenance">Apply Maintenance</button>
              <button class="btn purple" id="btnFetchSwitches">Fetch Switches</button>
            </div>

            <div class="footerNote">
              Backend endpoints expected (recommended):<br>
              <b>GET /api/admin/switches?set=builder|video|stock</b><br>
              <b>POST /api/admin/switches</b> with <b>{ set, key, action }</b><br>
              <b>POST /api/admin/maintenance</b> with <b>{ mode }</b>
            </div>
          </div>

          <div class="box">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
              <div style="font-weight:850; font-size:12px;">Logs</div>
              <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                <label style="margin:0; font-size:12px; font-weight:800; color:var(--muted);">Log Filter</label>
                <select class="select" id="logFilter" style="width:200px;">
                  <option value="all">All</option>
                  <option value="jobs">Jobs</option>
                  <option value="switches">Switches</option>
                  <option value="health">Health</option>
                  <option value="errors">Errors</option>
                </select>
              </div>
            </div>

            <div class="logBox" id="logOutput">Logs will appear here…</div>

            <div class="btnRow">
              <button class="btn ghost" id="btnClearLogs">Clear</button>
              <button class="btn ghost" id="btnCopyLogs">Copy</button>
            </div>

            <div class="footerNote">Endpoint expected: <b>GET /api/admin/logs?filter=all|jobs|switches|health|errors</b></div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== Local storage keys =====
    const LS = {
      apiBase: "bossmind_api_base",
      adminKey: "bossmind_admin_key",
      activeTab: "bossmind_active_tab",
      autoMode: "bossmind_auto_mode",
      videoType: "bossmind_video_type",
      videoLang: "bossmind_video_lang"
    };

    const el = (id) => document.getElementById(id);

    const logOutput = el("logOutput");
    function log(line){
      const ts = new Date().toISOString().replace("T"," ").replace("Z","");
      logOutput.textContent += `\n[${ts}] ${line}`;
      logOutput.scrollTop = logOutput.scrollHeight;
    }

    function setBackendUI(isUp){
      const dot = el("backendDot");
      const text = el("backendText");
      dot.style.background = isUp ? "var(--ok)" : "var(--bad)";
      dot.style.boxShadow = isUp ? "0 0 0 3px rgba(30,227,165,.12)" : "0 0 0 3px rgba(255,77,109,.12)";
      text.textContent = isUp ? "Backend: up" : "Backend: down";
    }

    function getApiBase(){
      return (localStorage.getItem(LS.apiBase) || "").trim();
    }
    function getAdminKey(){
      return (localStorage.getItem(LS.adminKey) || "").trim();
    }

    function headers(){
      const h = { "Content-Type":"application/json" };
      const key = getAdminKey();
      if(key) h["x-admin-key"] = key;
      return h;
    }

    async function safeFetch(url, opts={}){
      try{
        const res = await fetch(url, opts);
        const text = await res.text();
        let json = null;
        try{ json = JSON.parse(text); }catch(_){}
        return { ok: res.ok, status: res.status, text, json };
      }catch(err){
        return { ok:false, status:0, text:String(err), json:null };
      }
    }

    // ===== Tabs =====
    const tabs = [
      { id:"tabP1", panel:"panelP1", title:"Project 1 — AI Builder", sub:"Core tasks, status snapshot, and connection" },
      { id:"tabP2", panel:"panelP2", title:"Project 2 — AI Video Generator", sub:"Queue, scenario review, render, publish, and preferences" },
      { id:"tabP3", panel:"panelP3", title:"Project 3 — AI Stock System", sub:"Signals, risk, watchlist sync, and reporting" },
    ];

    function activateTab(tabKey){
      tabs.forEach(t=>{
        el(t.id).classList.toggle("active", t.id === tabKey);
        el(t.panel).classList.toggle("active", t.id === tabKey);
      });
      const t = tabs.find(x=>x.id===tabKey) || tabs[0];
      el("panelTitle").textContent = t.title;
      el("panelSub").textContent = t.sub;
      localStorage.setItem(LS.activeTab, tabKey);
      log(`Switched to ${t.title}`);
    }

    document.querySelectorAll(".tab").forEach(btn=>{
      btn.addEventListener("click", ()=> activateTab(btn.id));
    });

    // ===== Connection Save / Ping =====
    function refreshConnUI(){
      const base = getApiBase();
      el("apiBase").value = base;
      el("adminKey").value = getAdminKey();
      el("chipApi").textContent = base ? `API: set` : `API: not set`;
      el("chipApi").parentElement.classList.toggle("ok", !!base);
      el("chipApi").parentElement.classList.toggle("bad", !base);
    }

    el("btnSaveConn").addEventListener("click", ()=>{
      const base = el("apiBase").value.trim();
      const key  = el("adminKey").value.trim();
      localStorage.setItem(LS.apiBase, base);
      localStorage.setItem(LS.adminKey, key);
      refreshConnUI();
      log("Connection saved.");
    });

    el("btnPing").addEventListener("click", async ()=>{
      const base = getApiBase();
      if(!base){ log("Ping blocked: API Base URL not set."); setBackendUI(false); return; }
      log(`Ping → ${base}/health`);
      const r = await safeFetch(`${base.replace(/\/$/,"")}/health`, { method:"GET", headers: headers() });
      if(r.ok){
        setBackendUI(true);
        log("Ping OK.");
      }else{
        setBackendUI(false);
        log(`Ping failed (${r.status}): ${r.text.slice(0,200)}`);
      }
    });

    // ===== Global buttons =====
    el("btnRefreshAll").addEventListener("click", ()=>{
      log("Refresh All (UI) triggered.");
    });

    el("btnHealth").addEventListener("click", async ()=>{
      const base = getApiBase();
      if(!base){ log("Health blocked: API Base URL not set."); setBackendUI(false); return; }
      log("Run Health Check…");
      const r = await safeFetch(`${base.replace(/\/$/,"")}/health`, { method:"GET", headers: headers() });
      if(r.ok){ setBackendUI(true); log("Health: OK"); }
      else { setBackendUI(false); log(`Health: FAIL (${r.status})`); }
    });

    el("btnSyncAll").addEventListener("click", ()=>{
      log("Sync (Sheet / DB / Config) requested (UI).");
    });

    // ===== Jobs trigger =====
    async function triggerJob(job){
      const base = getApiBase();
      if(!base){ log("Job blocked: API Base URL not set."); setBackendUI(false); return; }

      const activeTab = localStorage.getItem(LS.activeTab) || "tabP1";
      const scope =
        activeTab === "tabP1" ? "builder" :
        activeTab === "tabP2" ? "video"   :
        "stock";

      const payload = {
        job,
        scope,
        prefs: {
          videoType: localStorage.getItem(LS.videoType) || "funny",
          videoLang: localStorage.getItem(LS.videoLang) || "auto"
        }
      };

      log(`Job → ${job} (scope=${scope})`);
      const r = await safeFetch(`${base.replace(/\/$/,"")}/api/admin/jobs`, {
        method:"POST",
        headers: headers(),
        body: JSON.stringify(payload)
      });

      if(r.ok){
        setBackendUI(true);
        log(`Job accepted: ${job}`);
      }else{
        setBackendUI(false);
        log(`Job failed (${r.status}): ${r.text.slice(0,240)}`);
      }
    }

    document.querySelectorAll("[data-job]").forEach(btn=>{
      btn.addEventListener("click", ()=> triggerJob(btn.getAttribute("data-job")));
    });

    // ===== Builder status =====
    el("btnRefreshStatus").addEventListener("click", async ()=>{
      const base = getApiBase();
      if(!base){ log("Status blocked: API Base URL not set."); setBackendUI(false); return; }
      log("Fetch builder status…");
      const r = await safeFetch(`${base.replace(/\/$/,"")}/api/admin/status/builder`, { method:"GET", headers: headers() });
      if(r.ok && r.json){
        setBackendUI(true);
        el("s1").textContent = r.json.lastExport ?? "—";
        el("s2").textContent = r.json.supabaseSync ?? "—";
        el("s3").textContent = r.json.activeTheme ?? "—";
        el("s4").textContent = r.json.errors24h ?? "—";
        log("Builder status updated.");
      }else{
        setBackendUI(false);
        log(`Builder status failed (${r.status}): ${r.text.slice(0,240)}`);
      }
    });

    // ===== Stock status =====
    async function refreshStockStatus(){
      const base = getApiBase();
      if(!base){ return; }
      const r = await safeFetch(`${base.replace(/\/$/,"")}/api/admin/status/stock`, { method:"GET", headers: headers() });
      if(r.ok && r.json){
        setBackendUI(true);
        el("stk1").textContent = r.json.marketSession ?? "—";
        el("stk2").textContent = r.json.signalsToday ?? "—";
        el("stk3").textContent = r.json.riskLevel ?? "—";
        el("stk4").textContent = r.json.lastReport ?? "—";
        log("Stock status updated.");
      }
    }

    // ===== Video prefs =====
    function loadVideoPrefs(){
      const vt = localStorage.getItem(LS.videoType) || "funny";
      const vl = localStorage.getItem(LS.videoLang) || "auto";
      el("videoType").value = vt;
      el("videoLang").value = vl;
    }
    el("btnSaveVideoPrefs").addEventListener("click", ()=>{
      localStorage.setItem(LS.videoType, el("videoType").value);
      localStorage.setItem(LS.videoLang, el("videoLang").value);
      log("Video preferences saved.");
    });

    // ===== Switches / maintenance (UI) =====
    function toggleButtonState(btn, on){
      btn.classList.toggle("green", on);
      btn.classList.toggle("ghost", !on);
      btn.textContent = btn.textContent.replace("ON","").replace("OFF","").trim() + (on ? " (ON)" : " (OFF)");
    }

    // Local-only visual toggle (safe)
    const localSwitchState = {};
    document.querySelectorAll("[data-switch]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const key = btn.getAttribute("data-switch");
        localSwitchState[key] = !localSwitchState[key];
        // reset label safely
        btn.textContent = btn.textContent.replace(/\s+\(ON\)|\s+\(OFF\)/g,"");
        btn.classList.remove("green","ghost");
        btn.classList.add(localSwitchState[key] ? "green" : "ghost");
        btn.textContent += localSwitchState[key] ? " (ON)" : " (OFF)";
        log(`Local switch toggled: ${key} = ${localSwitchState[key] ? "ON" : "OFF"}`);
      });
    });

    el("btnApplyMaintenance").addEventListener("click", async ()=>{
      const base = getApiBase();
      if(!base){ log("Maintenance blocked: API Base URL not set."); setBackendUI(false); return; }
      const mode = el("maintenanceMode").value;
      log(`Apply maintenance: ${mode.toUpperCase()}`);
      const r = await safeFetch(`${base.replace(/\/$/,"")}/api/admin/maintenance`, {
        method:"POST", headers: headers(), body: JSON.stringify({ mode })
      });
      if(r.ok){ setBackendUI(true); log("Maintenance applied."); }
      else { setBackendUI(false); log(`Maintenance failed (${r.status}): ${r.text.slice(0,240)}`); }
    });

    el("btnFetchSwitches").addEventListener("click", async ()=>{
      const base = getApiBase();
      if(!base){ log("Fetch switches blocked: API Base URL not set."); setBackendUI(false); return; }
      const set = el("featureSet").value;
      log(`Fetch switches: set=${set}`);
      const r = await safeFetch(`${base.replace(/\/$/,"")}/api/admin/switches?set=${encodeURIComponent(set)}`, {
        method:"GET", headers: headers()
      });
      if(r.ok){ setBackendUI(true); log("Switches fetched (check backend response)."); }
      else { setBackendUI(false); log(`Fetch switches failed (${r.status}): ${r.text.slice(0,240)}`); }
    });

    // ===== Logs =====
    el("btnLoadLogs").addEventListener("click", async ()=>{
      const base = getApiBase();
      if(!base){ log("Load logs blocked: API Base URL not set."); setBackendUI(false); return; }
      const filter = el("logFilter").value || "all";
      log(`Load logs: filter=${filter}`);
      const r = await safeFetch(`${base.replace(/\/$/,"")}/api/admin/logs?filter=${encodeURIComponent(filter)}`, {
        method:"GET", headers: headers()
      });
      if(r.ok){
        setBackendUI(true);
        log("Logs loaded.");
        if(r.json){
          logOutput.textContent = "Logs:\n" + JSON.stringify(r.json, null, 2);
        }else{
          logOutput.textContent = r.text || "No logs.";
        }
      }else{
        setBackendUI(false);
        log(`Load logs failed (${r.status}): ${r.text.slice(0,240)}`);
      }
    });

    el("btnAutoToggle").addEventListener("click", ()=>{
      const cur = (localStorage.getItem(LS.autoMode) || "off") === "on";
      const next = !cur;
      localStorage.setItem(LS.autoMode, next ? "on" : "off");
      el("btnAutoToggle").textContent = `Auto: ${next ? "ON" : "OFF"}`;
      log(`Auto mode set to ${next ? "ON" : "OFF"} (UI only).`);
    });

    el("btnClearLogs").addEventListener("click", ()=>{
      logOutput.textContent = "Logs cleared.";
    });

    el("btnCopyLogs").addEventListener("click", async ()=>{
      try{
        await navigator.clipboard.writeText(logOutput.textContent || "");
        log("Logs copied to clipboard.");
      }catch(e){
        log("Copy failed (browser permission).");
      }
    });

    // ===== Clock =====
    function tick(){
      const d = new Date();
      el("clockText").textContent = d.toLocaleString();
    }
    setInterval(tick, 1000);
    tick();

    // ===== Init =====
    (function init(){
      // clean default log box
      logOutput.textContent = "Logs will appear here…";
      refreshConnUI();
      loadVideoPrefs();
      el("btnAutoToggle").textContent = `Auto: ${(localStorage.getItem(LS.autoMode) || "off").toUpperCase()}`;
      const saved = localStorage.getItem(LS.activeTab) || "tabP1";
      activateTab(saved);
      setBackendUI(false);

      // attempt silent stock status refresh if base set
      if(getApiBase()){ refreshStockStatus(); }
      log("UI loaded.");
    })();
  </script>
</body>
</html>
